<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Account - RedStore</title>
  <link rel="stylesheet" href="Account.css" />
  <link rel="stylesheet" href="shopping.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <!-- Header Section -->
  <header class="header">
    <div class="header-main">
      <div class="container">
        <div class="logo">
          <img src="../../assests/logo-white.png" alt="RedStore" />
        </div>
        
        <div class="search-container">
          <div class="search-box">
            <select class="category-select">
              <option>All Categories</option>
              <option>Electronics</option>
              <option>Fashion</option>
              <option>Home & Kitchen</option>
              <option>Beauty</option>
              <option>Sports</option>
            </select>
            <input type="text" id="searchInput" placeholder="Search for products, brands and more..." />
            <button class="search-btn"><i class="fas fa-search"></i></button>
          </div>
          <div class="search-suggestions" id="searchSuggestions"></div>
        </div>
        
        <div class="header-actions">
          <!-- Auth Buttons (shown when not logged in) -->
          <div class="auth-buttons" id="authButtons" style="display: none;">
            <a href="Login.html" class="auth-btn login-btn">
              <i class="fas fa-sign-in-alt"></i>
              <span>Login</span>
            </a>
            <a href="signup.html" class="auth-btn signup-btn">
              <i class="fas fa-user-plus"></i>
              <span>Sign Up</span>
            </a>
          </div>
          
          <!-- User Menu (shown when logged in) -->
          <div class="user-menu" id="userMenu">
            <button class="user-btn" id="userBtn">
              <i class="fas fa-user"></i>
              <span>Account</span>
            </button>
            <div class="user-dropdown" id="userDropdown">
              <div class="user-info">
                <i class="fas fa-user-circle"></i>
                <span id="userName">Welcome to RedStore</span>
              </div>
              <a href="Account.html" class="dropdown-item"><i class="fas fa-user"></i> My Account</a>
              <a href="cart.html" class="dropdown-item"><i class="fas fa-shopping-cart"></i> Cart</a>
              <a href="#" class="dropdown-item"><i class="fas fa-box"></i> Orders</a>
              <a href="#" class="dropdown-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
          </div>
          
          <div class="cart-menu">
            <a href="cart.html" class="cart-btn">
              <i class="fas fa-shopping-cart"></i>
              <span class="cart-count" id="cartCount">0</span>
            </a>
          </div>
        </div>
      </div>
    </div>
    
    <nav class="main-nav">
      <div class="container">
        <div class="nav-left">
          <div class="category-menu">
            <button class="category-btn">
              <i class="fas fa-bars"></i>
              All Categories
            </button>
            <div class="mega-menu" id="megaMenu">
              <div class="mega-menu-content">
                <div class="menu-column">
                  <h4>Electronics</h4>
                  <ul>
                    <li><a href="#">Smartphones</a></li>
                    <li><a href="#">Laptops</a></li>
                    <li><a href="#">TVs & Audio</a></li>
                    <li><a href="#">Cameras</a></li>
                  </ul>
                </div>
                <div class="menu-column">
                  <h4>Fashion</h4>
                  <ul>
                    <li><a href="#">Men's Clothing</a></li>
                    <li><a href="#">Women's Fashion</a></li>
                    <li><a href="#">Kids Wear</a></li>
                    <li><a href="#">Footwear</a></li>
                  </ul>
                </div>
                <div class="menu-column">
                  <h4>Home & Living</h4>
                  <ul>
                    <li><a href="#">Furniture</a></li>
                    <li><a href="#">Kitchen & Dining</a></li>
                    <li><a href="#">Home Decor</a></li>
                    <li><a href="#">Bedding</a></li>
                  </ul>
                </div>
                <div class="menu-column">
                  <h4>Beauty & Health</h4>
                  <ul>
                    <li><a href="#">Makeup</a></li>
                    <li><a href="#">Skincare</a></li>
                    <li><a href="#">Hair Care</a></li>
                    <li><a href="#">Fragrances</a></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
          <ul class="nav-links">
            <li><a href="shopping.html">Home</a></li>
            <li><a href="#deals">Deals</a></li>
            <li><a href="#new">New Arrivals</a></li>
            <li><a href="#brands">Brands</a></li>
            <li><a href="#offers">Offers</a></li>
          </ul>
        </div>
        <div class="nav-right">
          <div class="location-selector">
            <i class="fas fa-map-marker-alt"></i>
            <span>Deliver to: Address</span>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <!-- Account Page Content -->
  <main class="account-page">
    <div class="container">
      <!-- Simple Account Header -->
      <div class="account-header">
        <h1>My Account</h1>
        <p>Welcome back, <span id="userNameHeader">User</span></p>
      </div>

      <!-- Account Navigation -->
      <div class="account-nav">
        <button class="nav-tab active" data-section="overview">
          <i class="fas fa-home"></i>
          Overview
        </button>
        <button class="nav-tab" data-section="orders">
          <i class="fas fa-box"></i>
          Order History
        </button>
        <button class="nav-tab" data-section="profile">
          <i class="fas fa-user"></i>
          Profile
        </button>
        <button class="nav-tab" data-section="addresses">
          <i class="fas fa-map-marker-alt"></i>
          Addresses
        </button>
        <button class="nav-tab" data-section="contact">
          <i class="fas fa-phone"></i>
          Contact
        </button>
        <button class="nav-tab" data-section="track-order">
          <i class="fas fa-truck"></i>
          Track Order
        </button>
      </div>

      <!-- Account Content -->
      <div class="account-content">
        <!-- Overview Section -->
        <section class="content-section active" id="overview-section">
          <div class="user-overview">
            <div class="user-profile-card">
              <div class="profile-header">
                <div class="profile-avatar">
                  <i class="fas fa-user-circle"></i>
                </div>
                <div class="profile-info">
                  <h2 id="userDisplayName">User Name</h2>
                  <p id="userDisplayEmail">user@example.com</p>
                  <span class="member-since">Member since <span id="memberSince">2024</span></span>
                </div>
              </div>
              
              <div class="profile-details">
                <div class="detail-row">
                  <div class="detail-label">
                    <i class="fas fa-user"></i>
                    <span>Full Name</span>
                  </div>
                  <div class="detail-value" id="userFullName">John Doe</div>
                </div>
                
                <div class="detail-row">
                  <div class="detail-label">
                    <i class="fas fa-envelope"></i>
                    <span>Email Address</span>
                  </div>
                  <div class="detail-value" id="userEmail">john.doe@example.com</div>
                </div>
                
                <div class="detail-row">
                  <div class="detail-label">
                    <i class="fas fa-at"></i>
                    <span>Username</span>
                  </div>
                  <div class="detail-value" id="userUsername">johndoe</div>
                </div>
                
                <div class="detail-row">
                  <div class="detail-label">
                    <i class="fas fa-phone"></i>
                    <span>Phone Number</span>
                  </div>
                  <div class="detail-value" id="userPhone">+91 98765 43210</div>
                </div>
                
                <div class="detail-row">
                  <div class="detail-label">
                    <i class="fas fa-calendar"></i>
                    <span>Date of Birth</span>
                  </div>
                  <div class="detail-value" id="userDOB">January 1, 1990</div>
                </div>
                
                <div class="detail-row">
                  <div class="detail-label">
                    <i class="fas fa-venus-mars"></i>
                    <span>Gender</span>
                  </div>
                  <div class="detail-value" id="userGender">Male</div>
                </div>
              </div>
              
              <div class="profile-actions">
                <button class="btn-primary" onclick="showSection('profile')">
                  <i class="fas fa-edit"></i>
                  Edit Profile
                </button>
                <button class="btn-secondary" onclick="showSection('orders')">
                  <i class="fas fa-box"></i>
                  View Orders
                </button>
              </div>
            </div>
            
            <div class="quick-stats">
              <div class="stat-card">
                <div class="stat-icon">
                  <i class="fas fa-shopping-bag"></i>
                </div>
                <div class="stat-info">
                  <h3 id="totalOrders">0</h3>
                  <p>Total Orders</p>
                </div>
              </div>
              
              <div class="stat-card">
                <div class="stat-icon">
                  <i class="fas fa-rupee-sign"></i>
                </div>
                <div class="stat-info">
                  <h3 id="totalSpent">Rs. 0</h3>
                  <p>Total Spent</p>
                </div>
              </div>
              
              <div class="stat-card">
                <div class="stat-icon">
                  <i class="fas fa-map-marker-alt"></i>
                </div>
                <div class="stat-info">
                  <h3 id="addressCount">0</h3>
                  <p>Saved Addresses</p>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Fresh Order History Section -->
        <section class="content-section" id="orders-section">
          <div class="section-header">
            <h2>Order History</h2>
          </div>
          <div class="orders-filters">
            <button class="filter-btn active" data-status="ALL">All</button>
            <button class="filter-btn" data-status="PENDING">Pending</button>
            <button class="filter-btn" data-status="DELIVERED">Delivered</button>
          </div>
          <div id="ordersList" class="orders-list">
            <!-- Orders will be rendered here -->
          </div>
        </section>
 
        <!-- Profile Section -->
        <section class="content-section" id="profile-section">
          <div class="section-header">
            <h2>Profile Settings</h2>
            <p>Update your personal information</p>
          </div>
          
          <div class="profile-form">
            <form id="profileForm">
              <div class="form-row">
                <div class="form-group">
                  <label for="fullName">Full Name</label>
                  <input type="text" id="fullName" name="fullName" value="John Doe" />
                </div>
                <div class="form-group">
                  <label for="email">Email Address</label>
                  <input type="email" id="email" name="email" value="john.doe@example.com" />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="phone">Phone Number</label>
                  <input type="tel" id="phone" name="phone" value="+91 98765 43210" />
                </div>
                <div class="form-group">
                  <label for="dateOfBirth">Date of Birth</label>
                  <input type="date" id="dateOfBirth" name="dateOfBirth" value="1990-01-01" />
                </div>
              </div>
              <div class="form-group">
                <label for="gender">Gender</label>
                <select id="gender" name="gender">
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div class="form-actions">
                <button type="submit" class="btn-primary">Save Changes</button>
                <button type="button" class="btn-secondary">Cancel</button>
              </div>
            </form>
          </div>
        </section>

        <!-- Addresses Section -->
        <section class="content-section" id="addresses-section">
          <div class="section-header">
            <h2>My Addresses</h2>
            <button class="btn-primary" onclick="showAddAddressModal()">
              <i class="fas fa-plus"></i>
              Add New Address
            </button>
          </div>
          
          <div class="addresses-list" id="addressesList">
            <!-- Addresses will be loaded here -->
          </div>
        </section>

        <!-- Address Modal -->
        <div id="addressModal" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 id="addressModalTitle">Add New Address</h3>
              <button class="close-btn" onclick="closeAddressModal()">&times;</button>
            </div>
            <form id="addressForm" onsubmit="saveAddress(event)">
              <div class="form-group">
                <label for="addressType">Address Type</label>
                <select id="addressType" required>
                  <option value="Home">Home</option>
                  <option value="Work">Work</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div class="form-group">
                <label for="fullName">Full Name</label>
                <input type="text" id="fullName" required>
              </div>
              <div class="form-group">
                <label for="addressLine1">Address Line 1</label>
                <input type="text" id="addressLine1" placeholder="Street address, P.O. box, company name" required>
              </div>
              <div class="form-group">
                <label for="addressLine2">Address Line 2</label>
                <input type="text" id="addressLine2" placeholder="Apartment, suite, unit, building, floor, etc.">
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="city">City</label>
                  <input type="text" id="city" required>
                </div>
                <div class="form-group">
                  <label for="state">State</label>
                  <input type="text" id="state" required>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label for="pincode">Pincode</label>
                  <input type="text" id="pincode" required>
                </div>
                <div class="form-group">
                  <label for="phone">Phone Number</label>
                  <input type="tel" id="phone" required>
                </div>
              </div>
              <div class="form-group">
                <label class="checkbox-label">
                  <input type="checkbox" id="isDefault">
                  Set as default address
                </label>
              </div>
              <div class="form-actions">
                <button type="submit" class="btn-primary">Save Address</button>
                <button type="button" class="btn-secondary" onclick="closeAddressModal()">Cancel</button>
              </div>
            </form>
          </div>
        </div>

        

        <!-- Contact Section -->
        <section class="content-section" id="contact-section">
          <div class="section-header">
            <h2>Contact</h2>
            <p>Reach out anytime. We'll get back to you as soon as possible.</p>
          </div>
          <div class="addresses-list">
            <div class="address-card">
              <div class="address-header">
                <h4>Support</h4>
                <span class="address-type">Primary</span>
              </div>
              <div class="address-content">
                <p><i class="fas fa-phone"></i> 9492451504</p>
                <p><i class="fas fa-envelope"></i> <a href="mailto:mothukuriomeprakash@gmail.com">mothukuriomeprakash@gmail.com</a></p>
              </div>
            </div>
          </div>
        </section>

        <!-- Track Order Section -->
        <section class="content-section" id="track-order-section">
          <div class="section-header">
            <h2>Track Order</h2>
            <p>Track your order status and delivery progress</p>
          </div>
          
          <div class="track-order-container">
            <!-- Order Search -->
            <div class="order-search">
              <div class="search-box">
                <input type="text" id="orderSearchInput" placeholder="Enter Order ID or Product Name" />
                <button class="btn-primary" onclick="searchOrder()">
                  <i class="fas fa-search"></i>
                  Track Order
                </button>
              </div>
            </div>

            <!-- Recent Orders for Tracking -->
            <div class="recent-orders">
              <h3>Recent Orders</h3>
              <div id="recentOrdersList" class="orders-list">
                <!-- Orders will be loaded here -->
              </div>
            </div>

            <!-- Order Tracking Details -->
            <div id="orderTrackingDetails" class="tracking-details" style="display: none;">
              <div class="tracking-header">
                <h3>Order #<span id="trackingOrderId">12345</span></h3>
                <p class="order-status" id="trackingOrderStatus">In Transit</p>
              </div>
              
              <div class="tracking-timeline">
                <div class="timeline-item completed">
                  <div class="timeline-icon">
                    <i class="fas fa-check-circle"></i>
                  </div>
                  <div class="timeline-content">
                    <h4>Order Placed</h4>
                    <p>Your order has been successfully placed</p>
                    <span class="timeline-date">Dec 15, 2024 - 10:30 AM</span>
                  </div>
                </div>
                
                <div class="timeline-item completed">
                  <div class="timeline-icon">
                    <i class="fas fa-check-circle"></i>
                  </div>
                  <div class="timeline-content">
                    <h4>Order Confirmed</h4>
                    <p>Your order has been confirmed and is being processed</p>
                    <span class="timeline-date">Dec 15, 2024 - 11:45 AM</span>
                  </div>
                </div>
                
                <div class="timeline-item active">
                  <div class="timeline-icon">
                    <i class="fas fa-truck"></i>
                  </div>
                  <div class="timeline-content">
                    <h4>Out for Delivery</h4>
                    <p>Your order is out for delivery</p>
                    <span class="timeline-date">Dec 16, 2024 - 9:15 AM</span>
                  </div>
                </div>
                
                <div class="timeline-item">
                  <div class="timeline-icon">
                    <i class="fas fa-home"></i>
                  </div>
                  <div class="timeline-content">
                    <h4>Delivered</h4>
                    <p>Your order has been delivered</p>
                    <span class="timeline-date">Expected: Dec 16, 2024</span>
                  </div>
                </div>
              </div>
              
              <div class="delivery-info">
                <div class="delivery-card">
                  <h4><i class="fas fa-map-marker-alt"></i> Delivery Address</h4>
                  <p id="deliveryAddress">123 Main Street, City, State 12345</p>
                </div>
                
                <div class="delivery-card">
                  <h4><i class="fas fa-phone"></i> Contact Number</h4>
                  <p id="deliveryContact">+91 98765 43210</p>
                </div>
                
                <div class="delivery-card">
                  <h4><i class="fas fa-calendar"></i> Expected Delivery</h4>
                  <p id="expectedDelivery">December 16, 2024</p>
                </div>
              </div>
            </div>
          </div>
        </section>

       
      </div>
    </div>
  </main>

   <!-- Footer -->
   <footer class="footer" id="contact-section">
    <div class="footer-container">
      <div class="footer-column">
        <h3>About RedStore</h3>
        <ul>
          <li><a href="#">About Us</a></li>
          <li><a href="#">Careers</a></li>
          <li><a href="#">Press & Media</a></li>
          <li><a href="#">RedStore Science</a></li>
          <li><a href="#">Investor Relations</a></li>
        </ul>
      </div>

      <div class="footer-column">
        <h3>Connect With Us</h3>
        <ul>
          <li><a href="#">Facebook</a></li>
          <li><a href="#">Twitter</a></li>
          <li><a href="#">Instagram</a></li>
          <li><a href="#">YouTube</a></li>
          <li><a href="#">LinkedIn</a></li>
        </ul>
        <div class="contact-info">
          <p><i class="fas fa-phone"></i> 9492451504</p>
          <p><i class="fas fa-envelope"></i> <a href="mailto:mothukuriomeprakash@gmail.com">mothukuriomeprakash@gmail.com</a></p>
        </div>
      </div>

      <div class="footer-column">
        <h3>Make Money With Us</h3>
        <ul>
          <li><a href="#">Sell on RedStore</a></li>
          <li><a href="#">Become an Affiliate</a></li>
          <li><a href="#">Advertise Your Products</a></li>
          <li><a href="#">RedStore Pay</a></li>
          <li><a href="#">RedStore Business</a></li>
          <li><a href="#">RedStore Fresh</a></li>
          <li><a href="#">RedStore Prime</a></li>
        </ul>
      </div>

      <div class="footer-column">
        <h3>Let Us Help You</h3>
        <ul>
          <li><a href="#">Your Account</a></li>
          <li><a href="#">Returns Centre</a></li>
          <li><a href="#">100% Purchase Protection</a></li>
          <li><a href="#">RedStore App Download</a></li>
          <li><a href="#">Help</a></li>
          <li><a href="#">Customer Service</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-separator"></div>

    <div class="footer-bottom">
      <div class="footer-bottom-content">
        <div class="footer-logo">
          <span class="logo-text">RedStore</span>
        </div>
        <div class="footer-language">
          <select class="language-select">
            <option>English</option>
            <option>Hindi</option>
            <option>Telugu</option>
            <option>Tamil</option>
          </select>
          <span class="country">India</span>
        </div>
      </div>
      <div class="footer-links">
        <a href="#">Conditions of Use & Sale</a>
        <a href="#">Privacy Notice</a>
        <a href="#">Interest-Based Ads</a>
        <a href="#">Cookie Preferences</a>
        <span class="copyright">© 2025 RedStore.com, Inc. All rights reserved.</span>
      </div>
    </div>
  </footer>


  <!-- Order Tracking Modal -->
  <div class="modal" id="trackingModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Order Tracking</h3>
        <button class="close-modal" onclick="closeTrackingModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="tracking-info">
          <h4>Order #<span id="trackingOrderId"></span></h4>
          <div class="tracking-timeline">
            <div class="timeline-item completed">
              <div class="timeline-icon">
                <i class="fas fa-check-circle"></i>
              </div>
              <div class="timeline-content">
                <h5>Order Placed</h5>
                <p>Your order has been confirmed</p>
                <span class="timeline-date">Dec 10, 2024 - 2:30 PM</span>
              </div>
            </div>
            <div class="timeline-item completed">
              <div class="timeline-icon">
                <i class="fas fa-check-circle"></i>
              </div>
              <div class="timeline-content">
                <h5>Processing</h5>
                <p>Your order is being prepared</p>
                <span class="timeline-date">Dec 11, 2024 - 10:15 AM</span>
              </div>
            </div>
            <div class="timeline-item completed">
              <div class="timeline-icon">
                <i class="fas fa-check-circle"></i>
              </div>
              <div class="timeline-content">
                <h5>Shipped</h5>
                <p>Your order is on its way</p>
                <span class="timeline-date">Dec 12, 2024 - 3:45 PM</span>
              </div>
            </div>
            <div class="timeline-item active">
              <div class="timeline-icon">
                <i class="fas fa-truck"></i>
              </div>
              <div class="timeline-content">
                <h5>Out for Delivery</h5>
                <p>Your package will be delivered today</p>
                <span class="timeline-date">Dec 15, 2024 - 9:00 AM</span>
              </div>
            </div>
            <div class="timeline-item">
              <div class="timeline-icon">
                <i class="fas fa-home"></i>
              </div>
              <div class="timeline-content">
                <h5>Delivered</h5>
                <p>Package delivered successfully</p>
                <span class="timeline-date">Expected: Dec 15, 2024</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Check authentication status (unified with other pages)
        // Clear sample orders for new users
    function clearSampleOrders(_loggedInUser) { /* no local storage to clear */ }

    const API_BASE = 'http://localhost:8080/api';
    function getCookie(name) {
      const cname = name + '=';
      const decodedCookie = decodeURIComponent(document.cookie);
      const ca = decodedCookie.split(';');
      for (let i = 0; i < ca.length; i++) {
        let c = ca[i].trim();
        if (c.indexOf(cname) === 0) return c.substring(cname.length, c.length);
      }
      return '';
    }
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Account page loaded');
      
      // Check if user is logged in
      const username = getCookie('auth_username');
      console.log('Current user from cookie:', username);
      
      if (!username) {
        console.log('No user logged in, redirecting to login');
        window.location.href = 'Login.html';
        return;
      }
      
      // Set user name in header
      const userNameHeader = document.getElementById('userNameHeader');
      const userNameDropdown = document.getElementById('userName');
      const displayName = getCookie('auth_name') || username;
      if (userNameHeader) userNameHeader.textContent = displayName;
      if (userNameDropdown) userNameDropdown.textContent = `Welcome, ${displayName}`;
      
      // Loading notification removed as requested by user
      updateAccountStats();
      loadUserData();
    });

    // Check authentication status
    async function checkAuthStatus() {
      const username = getCookie('auth_username');
      
      if (username) {
        console.log('User authenticated:', username);
        
        // Toggle header buttons and set names
        const authButtons = document.getElementById('authButtons');
        const userMenu = document.getElementById('userMenu');
        const userNameHeader = document.getElementById('userNameHeader');
        const userNameDropdown = document.getElementById('userName');
        
        if (authButtons) authButtons.style.display = 'none';
        if (userMenu) userMenu.style.display = 'block';
        const displayName = getCookie('auth_name') || username;
        if (userNameHeader) userNameHeader.textContent = displayName;
        if (userNameDropdown) userNameDropdown.textContent = `Welcome, ${displayName}`;
        
        console.log('Updating account stats...');
        // Update stats
        updateAccountStats();
        
        // Load cart count
        loadCartCount();
        
        // Load user data
        loadUserData();
        
        // Update overview user details
        updateOverviewUserDetails(userData);
        
        // Check if user came from cart page and show orders section
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('from') === 'cart') {
          console.log('User came from cart, showing orders section...');
          // Show orders section
          showSection('orders');
          // Activate orders tab
          document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
          document.querySelector('[data-section="orders"]').classList.add('active');
        }
        
        console.log('Account page loaded successfully!');
      } else {
        console.log('User not authenticated, redirecting to login...');
        window.location.href = 'Login.html';
      }
    }

    // Load cart count from local storage
    async function loadCartCount() {
      const username = getCookie('auth_username');
      if (!username) return;
      const res = await fetch(`${API_BASE}/cart/${encodeURIComponent(username)}`);
      const cart = res.ok ? await res.json() : [];
      const totalItems = cart.reduce((total, item) => total + (item.quantity || 0), 0);
      const cartCountEl = document.getElementById('cartCount');
      if (cartCountEl) cartCountEl.textContent = totalItems;
    }

    // Navigation functionality
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', function() {
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        const section = this.getAttribute('data-section');
        showSection(section);
      });
    });

    // Show section function
    function showSection(sectionName) {
      // Show corresponding section
      document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
      const targetId = sectionName === 'contact' ? 'contact-section' : (sectionName + '-section');
      const target = document.getElementById(targetId);
      if (target) target.classList.add('active');
    }

    // User dropdown functionality
    document.getElementById('userBtn').addEventListener('click', function() {
      document.getElementById('userDropdown').classList.toggle('active');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.user-menu')) {
        document.getElementById('userDropdown').classList.remove('active');
      }
    });

    // Logout functionality (unified)
    function logout() {
      document.cookie = 'auth_username=; Max-Age=0; path=/';
      document.cookie = 'auth_name=; Max-Age=0; path=/';
      window.location.href = 'shopping.html';
    }

    // Copy coupon code
    function copyCoupon(code) {
      navigator.clipboard.writeText(code).then(() => {
        showNotification('Coupon code copied to clipboard!', 'success');
      });
    }

    // Show notification
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Profile form submission
    document.getElementById('profileForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      const profileData = Object.fromEntries(formData);
      
      const username = getCookie('auth_username');
      if (!username) { showNotification('Please login again.', 'error'); return; }
      try {
        const res = await fetch(`${API_BASE}/users/by-username/${encodeURIComponent(username)}`);
        if (!res.ok) throw new Error('Failed to load user');
        const existing = await res.json();
        const payload = {
          id: existing.id,
          username: existing.username,
          password: existing.password,
        email: profileData.email,
          phoneNumber: profileData.phone,
          fullName: profileData.fullName,
        dateOfBirth: profileData.dateOfBirth,
        gender: profileData.gender
      };
        const updateRes = await fetch(`${API_BASE}/users/${existing.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!updateRes.ok) throw new Error('Failed to update user');
        
        // Update auth cookies to reflect the new fullName
        setCookie('auth_name', payload.fullName || payload.username, 7);
        
        const userNameHeader = document.getElementById('userNameHeader');
        const userNameDropdown = document.getElementById('userName');
        if (userNameHeader) userNameHeader.textContent = payload.fullName || payload.username;
        if (userNameDropdown) userNameDropdown.textContent = `Welcome, ${payload.fullName || payload.username}`;
        showNotification('Profile updated successfully!', 'success');
      } catch (err) {
        showNotification('Failed to update profile.', 'error');
      }
    });

    // Order filters
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        // Add filter logic here
      });
    });

    // View order tracking
    function viewOrderTracking(orderId) {
      document.getElementById('trackingOrderId').textContent = orderId;
      document.getElementById('trackingModal').classList.add('active');
    }

    // Close tracking modal
    function closeTrackingModal() {
      document.getElementById('trackingModal').classList.remove('active');
    }

    // Show add address modal
    function showAddAddressModal() {
      // Implementation for adding new address
      showNotification('Add address functionality will be implemented', 'info');
    }

    // Show add payment modal
    function showAddPaymentModal() {
      // Implementation for adding new payment method
      showNotification('Add payment method functionality will be implemented', 'info');
    }

        // Update account statistics
    async function updateAccountStats() {
      const username = getCookie('auth_username');
      if (!username) {
        console.log('No username found in cookies');
        return;
      }
      try {
        const res = await fetch(`${API_BASE}/orders/${encodeURIComponent(username)}`);
        const orders = res.ok ? await res.json() : [];

        document.getElementById('totalOrders').textContent = orders.length;
        const totalSpent = orders.reduce((sum, o) => sum + (Number(o.totalAmount) || 0), 0);
        document.getElementById('totalSpent').textContent = `Rs. ${totalSpent.toLocaleString()}`;

        document.getElementById('addressCount').textContent = '1';
      } catch (error) {
        console.error('Error updating account stats:', error);
        document.getElementById('totalOrders').textContent = '0';
        document.getElementById('totalSpent').textContent = 'Rs. 0';
        document.getElementById('addressCount').textContent = '0';
      }
    }

    // View cart item function
    function viewCartItem(itemId) {
      showNotification(`Viewing cart item #${itemId}`, 'info');
      // TODO: Implement view cart item functionality - could show a modal with detailed information
    }

    async function buyAgain(productName, price = 0, imageUrl = '../../assests/product-1.jpg') {
      const username = getCookie('auth_username');
      if (!username) { showNotification('Please login to add to cart', 'error'); return; }
      try {
        await fetch(`${API_BASE}/cart`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, name: productName, price: Number(price) || 0, imageUrl, description: productName, quantity: 1 })
        });
        await loadCartCount();
        showNotification(`${productName} added to cart!`, 'success');
      } catch (e) {
        showNotification('Failed to add to cart', 'error');
      }
    }

    // Helper function to format product names for better display
    function formatProductNames(productName) {
      if (!productName) return 'Products';
      
      // If it's a comma-separated list, show first few items
      if (productName.includes(',')) {
        const products = productName.split(',').map(p => p.trim());
        if (products.length <= 2) {
          return products.join(', ');
        } else {
          return `${products[0]}, ${products[1]} +${products.length - 2} more`;
        }
      }
      
      // If it's a single product, truncate if too long
      if (productName.length > 50) {
        return productName.substring(0, 50) + '...';
      }
      
      return productName;
    }

    // Helper function to get product image based on product name
    function getProductImage(productName) {
      if (!productName) return '../../assests/product-1.jpg';
      
      const productNameLower = productName.toLowerCase();
      
      if (productNameLower.includes('levis') || productNameLower.includes('jeans')) {
        return '../../assests/levis';
      } else if (productNameLower.includes('zara') || productNameLower.includes('t-shirt')) {
        return '../../assests/product-1.jpg';
      } else if (productNameLower.includes('nike') || productNameLower.includes('shoes')) {
        return '../../assests/product-2.jpg';
      } else if (productNameLower.includes('adidas') || productNameLower.includes('sports')) {
        return '../../assests/product-3.jpg';
      } else if (productNameLower.includes('puma') || productNameLower.includes('casual')) {
        return '../../assests/product-4.jpg';
      } else if (productNameLower.includes('lacoste') || productNameLower.includes('polo')) {
        return '../../assests/product-5.jpg';
      } else if (productNameLower.includes('hrx') || productNameLower.includes('athletic')) {
        return '../../assests/product-6.jpg';
      } else if (productNameLower.includes('wrogn') || productNameLower.includes('formal')) {
        return '../../assests/product-7.jpg';
      } else if (productNameLower.includes('roadster') || productNameLower.includes('casual')) {
        return '../../assests/product-8.jpg';
      } else if (productNameLower.includes('maniac') || productNameLower.includes('street')) {
        return '../../assests/product-9.jpg';
      } else if (productNameLower.includes('dennislingo') || productNameLower.includes('premium')) {
        return '../../assests/product-10.jpg';
      } else if (productNameLower.includes('moda') || productNameLower.includes('rapido')) {
        return '../../assests/product-11.jpg';
      } else if (productNameLower.includes('campus') || productNameLower.includes('sneakers')) {
        return '../../assests/product-12.jpg';
      }
      
      return '../../assests/product-1.jpg'; // Default image
    }

    function formatOrderDate(d) {
      if (!d) return new Date().toLocaleDateString();
      try {
        return new Date(d).toLocaleDateString();
      } catch (e) {
        return d;
      }
    }

    // Update overview user details
    function updateOverviewUserDetails(user) {
      console.log('Updating user details with:', user);
      
      // Update profile header
      const userDisplayName = document.getElementById('userDisplayName');
      const userDisplayEmail = document.getElementById('userDisplayEmail');
      const memberSince = document.getElementById('memberSince');
      
      // Handle different user data structures
      const displayName = user.firstName ? `${user.firstName} ${user.lastName || ''}`.trim() : user.name || 'User Name';
      const email = user.email || 'user@example.com';
      
      if (userDisplayName) userDisplayName.textContent = displayName;
      if (userDisplayEmail) userDisplayEmail.textContent = email;
      if (memberSince) memberSince.textContent = new Date().getFullYear();
      
      // Update profile details with user information
      const userFullName = document.getElementById('userFullName');
      const userEmail = document.getElementById('userEmail');
      const userUsername = document.getElementById('userUsername');
      const userPhone = document.getElementById('userPhone');
      const userDOB = document.getElementById('userDOB');
      const userGender = document.getElementById('userGender');
      
      // Handle full name - check for firstName/lastName structure first, then fallback to name
      const fullName = user.firstName ? `${user.firstName} ${user.lastName || ''}`.trim() : user.name || 'John Doe';
      
      if (userFullName) userFullName.textContent = fullName;
      if (userEmail) userEmail.textContent = email;
      if (userUsername) userUsername.textContent = user.username || 'johndoe';
      if (userPhone) userPhone.textContent = user.phone || '+91 98765 43210';
      
      // Format date of birth
      if (userDOB) {
        if (user.dateOfBirth) {
          const dob = new Date(user.dateOfBirth);
          userDOB.textContent = dob.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          });
        } else {
          userDOB.textContent = 'Not specified';
        }
      }
      
      if (userGender) {
        if (user.gender) {
          userGender.textContent = user.gender.charAt(0).toUpperCase() + user.gender.slice(1);
        } else {
          userGender.textContent = 'Not specified';
        }
      }
    }

    // Load user data from local storage
    async function loadUserData() {
      const username = getCookie('auth_username');
      if (!username) return;
      try {
        const res = await fetch(`${API_BASE}/users/by-username/${encodeURIComponent(username)}`);
        if (!res.ok) return;
        const user = await res.json();
        const profileForm = document.getElementById('profileForm');
        if (profileForm) {
          const fullNameInput = document.getElementById('fullName');
          const emailInput = document.getElementById('email');
          const phoneInput = document.getElementById('phone');
          const dateOfBirthInput = document.getElementById('dateOfBirth');
          const genderInput = document.getElementById('gender');
          if (fullNameInput) fullNameInput.value = user.fullName || '';
          if (emailInput) emailInput.value = user.email || '';
          if (phoneInput) phoneInput.value = user.phoneNumber || '';
          if (dateOfBirthInput) dateOfBirthInput.value = user.dateOfBirth || '';
          if (genderInput) genderInput.value = user.gender || 'male';
        }
        updateOverviewUserDetails({
          name: user.fullName || user.username,
          email: user.email,
          username: user.username,
          phone: user.phoneNumber,
          dateOfBirth: user.dateOfBirth,
          gender: user.gender
        });
      } catch (_) {}
    }

    // Category menu functionality
    document.querySelector('.category-btn').addEventListener('click', function() {
      document.getElementById('megaMenu').classList.toggle('active');
    });

    // Close mega menu when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.category-menu')) {
        document.getElementById('megaMenu').classList.remove('active');
      }
    });

    // Close modal when clicking outside
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal')) {
        e.target.classList.remove('active');
      }
    });

    // Notification system
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.classList.add('show');
      }, 100);
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }

    // Add to cart functionality (for consistency with shopping page)
    async function addToCart(productName, price, imageUrl = '../../assests/product-1.jpg') {
      const username = getCookie('auth_username');
      if (!username) { showNotification('Please login to add to cart', 'error'); return; }
      
      // Get user's full name from cookie or use username as fallback
      const fullName = getCookie('auth_name') || username;
      
      await fetch(`${API_BASE}/cart`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          username, 
          fullName: fullName,
          name: productName, 
          price: Number(price), 
          imageUrl, 
          description: productName, 
          quantity: 1 
        })
      });
      await loadCartCount();
      showNotification(`${productName} added to cart!`, 'success');
    }

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', function(e) {
      const query = e.target.value;
      const suggestions = document.getElementById('searchSuggestions');
      
      if (query.length > 2) {
        const mockSuggestions = [
          `${query} smartphone`,
          `${query} laptop`,
          `${query} headphones`,
          `${query} watch`
        ];
        
        suggestions.innerHTML = mockSuggestions.map(suggestion => 
          `<div class="suggestion-item">${suggestion}</div>`
        ).join('');
        suggestions.style.display = 'block';
      } else {
        suggestions.style.display = 'none';
      }
    });

    // Close search suggestions when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.search-container')) {
        const suggestions = document.getElementById('searchSuggestions');
        if (suggestions) suggestions.style.display = 'none';
      }
    });

    // Track Order Functions
    async function loadRecentOrders() {
      const username = getCookie('auth_username');
      if (!username) return;
      
      try {
        const res = await fetch(`${API_BASE}/orders/${encodeURIComponent(username)}`);
        const orders = res.ok ? await res.json() : [];
        
        const recentOrdersList = document.getElementById('recentOrdersList');
        if (recentOrdersList) {
          if (orders.length > 0) {
            recentOrdersList.innerHTML = orders.slice(0, 5).map((order, idx) => `
              <div class="order-item" onclick="trackOrder('${order.orderId}')">
                <div class="order-info">
                  <h4>Order Item #${idx + 1}</h4>
                  <p>${order.productName || 'Products'}</p>
                  <span class="order-date">${formatOrderDate(order.createdAt)}</span>
                </div>
                <div class="order-status">
                  <span class="status-badge ${order.status.toLowerCase()}">${order.status}</span>
                  <i class="fas fa-chevron-right"></i>
                </div>
              </div>
            `).join('');
          } else {
            recentOrdersList.innerHTML = `
              <div class="empty-orders">
                <i class="fas fa-box-open"></i>
                <p>No orders found</p>
              </div>
            `;
          }
        }
      } catch (error) {
        console.error('Error loading recent orders:', error);
      }
    }

    async function searchOrder() {
      const searchInput = document.getElementById('orderSearchInput');
      const searchTerm = searchInput.value.trim();
      
      if (!searchTerm) {
        showNotification('Please enter an order ID or product name', 'error');
        return;
      }
      
      const username = getCookie('auth_username');
      if (!username) return;
      
      try {
        const res = await fetch(`${API_BASE}/orders/${encodeURIComponent(username)}`);
        const orders = res.ok ? await res.json() : [];
        
        const order = orders.find(o => 
          o.orderId.toString() === searchTerm || 
          o.productName.toLowerCase().includes(searchTerm.toLowerCase())
        );
        
        if (order) {
          trackOrder(order.orderId);
        } else {
          showNotification('Order not found', 'error');
        }
      } catch (error) {
        console.error('Error searching order:', error);
        showNotification('Error searching order', 'error');
      }
    }

    async function trackOrder(orderId) {
      const username = getCookie('auth_username');
      if (!username) return;
      
      try {
        const res = await fetch(`${API_BASE}/orders/${encodeURIComponent(username)}`);
        const orders = res.ok ? await res.json() : [];
        
        const order = orders.find(o => o.orderId.toString() === orderId.toString());
        
        if (order) {
          showOrderTracking(order);
        } else {
          showNotification('Order not found', 'error');
        }
      } catch (error) {
        console.error('Error tracking order:', error);
        showNotification('Error tracking order', 'error');
      }
    }

    async function showOrderTracking(order) {
      const trackingDetails = document.getElementById('orderTrackingDetails');
      
      if (trackingDetails) {
        // Get user's phone number and address from their profile
        const username = getCookie('auth_username');
        let userPhone = '+91 98765 43210'; // Default fallback
        let userAddress = 'No default address set'; // Default fallback
        
        if (username) {
          try {
            // Get user's phone number
            const res = await fetch(`${API_BASE}/users/by-username/${encodeURIComponent(username)}`);
            if (res.ok) {
              const user = await res.json();
              userPhone = user.phoneNumber || '+91 98765 43210';
            }
            
            // Get user's default address
            const savedAddresses = localStorage.getItem(`addresses_${username}`);
            if (savedAddresses) {
              const addresses = JSON.parse(savedAddresses);
              const defaultAddress = addresses.find(addr => addr.isDefault);
              if (defaultAddress) {
                userAddress = `${defaultAddress.fullName}, ${defaultAddress.addressLine1}${defaultAddress.addressLine2 ? ', ' + defaultAddress.addressLine2 : ''}, ${defaultAddress.city}, ${defaultAddress.state} ${defaultAddress.pincode}`;
              }
            }
          } catch (error) {
            console.error('Error fetching user data:', error);
          }
        }
        
        // Restore the original tracking details HTML with user's phone number
        trackingDetails.innerHTML = `
          <div class="tracking-header">
            <h3>Order #<span id="trackingOrderId">${order.orderId}</span></h3>
            <p class="order-status ${order.status.toLowerCase()}" id="trackingOrderStatus">${order.status || 'PENDING'}</p>
          </div>
          
          <div class="tracking-timeline">
            <div class="timeline-item completed">
              <div class="timeline-icon">
                <i class="fas fa-check-circle"></i>
              </div>
              <div class="timeline-content">
                <h4>Order Placed</h4>
                <p>Your order has been successfully placed</p>
                <span class="timeline-date">${formatOrderDate(order.createdAt)}</span>
              </div>
            </div>
            
            <div class="timeline-item ${order.status === 'PENDING' ? 'active' : 'completed'}">
              <div class="timeline-icon">
                <i class="fas fa-check-circle"></i>
              </div>
              <div class="timeline-content">
                <h4>Order Confirmed</h4>
                <p>Your order has been confirmed and is being processed</p>
                <span class="timeline-date">${formatOrderDate(order.createdAt)}</span>
              </div>
            </div>
            
            <div class="timeline-item ${order.status === 'DELIVERED' ? 'completed' : (order.status === 'PENDING' ? '' : 'active')}">
              <div class="timeline-icon">
                <i class="fas fa-truck"></i>
              </div>
              <div class="timeline-content">
                <h4>Out for Delivery</h4>
                <p>Your order is out for delivery</p>
                <span class="timeline-date">${order.status === 'DELIVERED' ? formatOrderDate(order.createdAt) : 'Expected: ' + formatOrderDate(order.createdAt)}</span>
              </div>
            </div>
            
            <div class="timeline-item ${order.status === 'DELIVERED' ? 'active' : ''}">
              <div class="timeline-icon">
                <i class="fas fa-home"></i>
              </div>
              <div class="timeline-content">
                <h4>Delivered</h4>
                <p>Your order has been delivered</p>
                <span class="timeline-date">${order.status === 'DELIVERED' ? formatOrderDate(order.createdAt) : 'Expected: ' + formatOrderDate(order.createdAt)}</span>
              </div>
            </div>
          </div>
          
          <div class="delivery-info">
            <div class="delivery-card">
              <h4><i class="fas fa-map-marker-alt"></i> Delivery Address</h4>
              <p id="deliveryAddress">${order.deliveryAddress || userAddress}</p>
            </div>
            
            <div class="delivery-card">
              <h4><i class="fas fa-phone"></i> Contact Number</h4>
              <p id="deliveryContact">${userPhone}</p>
            </div>
            
            <div class="delivery-card">
              <h4><i class="fas fa-calendar"></i> Expected Delivery</h4>
              <p id="expectedDelivery">${formatOrderDate(order.createdAt)}</p>
            </div>
          </div>
        `;
        
        trackingDetails.style.display = 'block';
        trackingDetails.scrollIntoView({ behavior: 'smooth' });
      }
    }

    // Load recent orders when track order tab is shown
    document.addEventListener('click', function(e) {
      if (e.target.closest('.nav-tab') && e.target.closest('.nav-tab').getAttribute('data-section') === 'track-order') {
        loadRecentOrders();
        showNoOrderSelected();
      }
    });

    // Show message when no order is selected
    function showNoOrderSelected() {
      const trackingDetails = document.getElementById('orderTrackingDetails');
      if (trackingDetails) {
        trackingDetails.innerHTML = `
          <div class="no-order-selected">
            <div class="no-order-icon">
              <i class="fas fa-search"></i>
            </div>
            <h3>Select an Order to Track</h3>
            <p>Click on any order from the list above or search for a specific order to view its tracking details.</p>
            <div class="tracking-tips">
              <h4>How to track your order:</h4>
              <ul>
                <li><i class="fas fa-mouse-pointer"></i> Click on any order from the "Recent Orders" list</li>
                <li><i class="fas fa-search"></i> Use the search box to find orders by Order ID or Product Name</li>
                <li><i class="fas fa-eye"></i> View detailed tracking timeline and delivery information</li>
              </ul>
            </div>
          </div>
        `;
        trackingDetails.style.display = 'block';
      }
    }

    // Address Management Functions
    let addresses = [];
    let editingAddressId = null;

    // Load addresses when addresses tab is shown
    document.addEventListener('click', function(e) {
      if (e.target.closest('.nav-tab') && e.target.closest('.nav-tab').getAttribute('data-section') === 'addresses') {
        loadAddresses();
      }
    });

    async function loadAddresses() {
      const username = getCookie('auth_username');
      if (!username) return;
      try {
        const res = await fetch(`${API_BASE}/addresses/${encodeURIComponent(username)}`);
        addresses = res.ok ? await res.json() : [];
        displayAddresses();
      } catch (error) {
        console.error('Error loading addresses:', error);
      }
    }

    function displayAddresses() {
      const addressesList = document.getElementById('addressesList');
      if (!addressesList) return;

      if (addresses.length === 0) {
        addressesList.innerHTML = `
          <div class="empty-addresses">
            <i class="fas fa-map-marker-alt"></i>
            <h3>No addresses saved</h3>
            <p>Add your first address to get started</p>
          </div>
        `;
      } else {
        addressesList.innerHTML = addresses.map((address, index) => `
          <div class="address-card">
            <div class="address-header">
              <h4>${address.type} Address</h4>
              ${address.isDefault ? '<span class="address-type">Default</span>' : ''}
            </div>
            <div class="address-content">
              <p>${address.fullName}</p>
              <p>${address.addressLine1}</p>
              ${address.addressLine2 ? `<p>${address.addressLine2}</p>` : ''}
              <p>${address.city}, ${address.state} ${address.pincode}</p>
              <p>Phone: ${address.phone}</p>
            </div>
            <div class="address-actions">
              <button class="btn-secondary" onclick="editAddress(${index})">
                <i class="fas fa-edit"></i>
                Edit
              </button>
              <button class="btn-secondary" onclick="deleteAddress(${index})">
                <i class="fas fa-trash"></i>
                Delete
              </button>
              ${!address.isDefault ? `
                <button class="btn-secondary" onclick="setDefaultAddress(${index})">
                  <i class="fas fa-star"></i>
                  Set Default
                </button>
              ` : ''}
            </div>
          </div>
        `).join('');
      }
    }

    function showAddAddressModal() {
      editingAddressId = null;
      document.getElementById('addressModalTitle').textContent = 'Add New Address';
      document.getElementById('addressForm').reset();
      document.getElementById('addressModal').classList.add('active');
    }

    function closeAddressModal() {
      document.getElementById('addressModal').classList.remove('active');
      editingAddressId = null;
    }

    function editAddress(index) {
      editingAddressId = index;
      const address = addresses[index];
      
      document.getElementById('addressModalTitle').textContent = 'Edit Address';
      document.getElementById('addressType').value = address.type;
      document.getElementById('fullName').value = address.fullName;
      document.getElementById('addressLine1').value = address.addressLine1;
      document.getElementById('addressLine2').value = address.addressLine2 || '';
      document.getElementById('city').value = address.city;
      document.getElementById('state').value = address.state;
      document.getElementById('pincode').value = address.pincode;
      document.getElementById('phone').value = address.phone;
      document.getElementById('isDefault').checked = address.isDefault;
      
      document.getElementById('addressModal').classList.add('active');
    }

    async function saveAddress(event) {
      event.preventDefault();
      
      const addressData = {
        type: document.getElementById('addressType').value,
        fullName: document.getElementById('fullName').value,
        addressLine1: document.getElementById('addressLine1').value,
        addressLine2: document.getElementById('addressLine2').value,
        city: document.getElementById('city').value,
        state: document.getElementById('state').value,
        pincode: document.getElementById('pincode').value,
        phone: document.getElementById('phone').value,
        isDefault: document.getElementById('isDefault').checked
      };

      const username = getCookie('auth_username');
      if (!username) return;

      try {
        const payload = { username, ...addressData };
        if (editingAddressId !== null) {
          const id = addresses[editingAddressId].id;
          await fetch(`${API_BASE}/addresses/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        } else {
          await fetch(`${API_BASE}/addresses`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        }
        await loadAddresses();
        closeAddressModal();
        showNotification('Address saved successfully!', 'success');
      } catch (error) {
        console.error('Error saving address:', error);
        showNotification('Error saving address', 'error');
      }
    }

    async function deleteAddress(index) {
      if (!confirm('Are you sure you want to delete this address?')) return;
      const id = addresses[index].id;
      await fetch(`${API_BASE}/addresses/${id}`, { method: 'DELETE' });
      await loadAddresses();
      showNotification('Address deleted successfully!', 'success');
    }

    async function setDefaultAddress(index) {
      const id = addresses[index].id;
      await fetch(`${API_BASE}/addresses/${id}/default`, { method: 'PUT' });
      await loadAddresses();
      showNotification('Default address updated!', 'success');
    }

    // Get default address for order tracking
    function getDefaultAddress() {
      const defaultAddress = addresses.find(addr => addr.isDefault);
      if (defaultAddress) {
        return `${defaultAddress.fullName}, ${defaultAddress.addressLine1}${defaultAddress.addressLine2 ? ', ' + defaultAddress.addressLine2 : ''}, ${defaultAddress.city}, ${defaultAddress.state} ${defaultAddress.pincode}`;
      }
      return 'No default address set';
    }

    // Load orders for Order History
    async function loadOrders() {
      const username = getCookie('auth_username');
      if (!username) return;
      try {
        const res = await fetch(`${API_BASE}/orders/${encodeURIComponent(username)}`);
        const orders = res.ok ? await res.json() : [];
        window.__ordersCache = orders;
        renderOrders('ALL');
      } catch (e) {
        console.error('Failed to load orders', e);
        renderOrders('ALL', []);
      }
    }

    function renderOrders(filter = 'ALL', data) {
      const orders = data || window.__ordersCache || [];
      const list = document.getElementById('ordersList');
      if (!list) return;

      const filtered = filter === 'ALL' ? orders : orders.filter(o => (o.status || 'PENDING') === filter);
      if (filtered.length === 0) {
        list.innerHTML = `
          <div class="empty-orders">
            <i class="fas fa-box-open"></i>
            <h3>No orders found</h3>
            <p>When you place an order, it will appear here.</p>
            <a href="shopping.html" class="btn-primary">Shop Now</a>
          </div>`;
        return;
      }

      list.innerHTML = filtered.map((o, idx) => {
        // Handle multiple product images if available
        const productImages = o.productImage ? o.productImage.split('|') : [];
        const mainImage = productImages[0] || o.productImage || '../../assests/product-1.jpg';
        
        return `
        <div class="order-card">
          <div class="order-header">
            <div>
              <h3>Order #${o.orderNumber || o.orderId}</h3>
              <p class="order-date"><i class="fas fa-calendar"></i> ${formatOrderDate(o.createdAt)}</p>
            </div>
            <span class="status-badge ${String(o.status || 'PENDING').toLowerCase()}">${o.status || 'PENDING'}</span>
          </div>
          <div class="order-body">
            <div class="order-product-image">
              <img src="${mainImage}" alt="${o.productName || 'Product'}" 
                   onerror="this.src='../../assests/product-1.jpg'" />
              ${productImages.length > 1 ? `<div class="image-count">+${productImages.length - 1}</div>` : ''}
            </div>
            <div class="order-info">
              <p class="order-products"><i class="fas fa-tag"></i> ${o.productName || 'Products'}</p>
              <p class="order-qty"><i class="fas fa-hashtag"></i> Qty: ${o.quantity || 1}</p>
            </div>
            <div class="order-total">
              <span>Total:</span>
              <strong>₹${Number(o.totalAmount || 0).toLocaleString()}</strong>
            </div>
          </div>
          <div class="order-actions">
            <button class="btn-secondary" onclick="trackOrder('${o.orderId}')"><i class="fas fa-location-arrow"></i> Track</button>
          </div>
        </div>
        `;
      }).join('');
    }

    // Hook up filter buttons for orders
    document.addEventListener('click', function(e) {
      const btn = e.target.closest('.filter-btn');
      if (!btn) return;
      if (!btn.closest('#orders-section')) return;
      document.querySelectorAll('#orders-section .filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const status = btn.getAttribute('data-status');
      renderOrders(status);
    });

    // Load orders when orders tab activated
    document.addEventListener('click', function(e) {
      const tab = e.target.closest('.nav-tab');
      if (!tab) return;
      if (tab.getAttribute('data-section') === 'orders') {
        loadOrders();
      }
    });

  </script>
</body>
</html>
